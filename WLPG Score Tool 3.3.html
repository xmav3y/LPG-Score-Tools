<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WLPG Score Input Tool</title>
<style>


    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #e0e0e0;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #111;
    }
    h1, h2 {
        font-family: 'Inter', 'Helvetica', 'Arial', sans-serif;
        font-weight: 600;
        margin-bottom: 20px;
        color: #222;
    }
    .card-row {
        display: flex;
        gap: 15px;
        width: 100%;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    #traineeNameCardRow { justify-content: center; }
    .card {
        background: #f5f5f5;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 15px;
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
        color: #111;
    }
    .card label { font-weight: 500; text-align: center; }
    .card input[type="text"], .card select {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 8px;
        text-align: center;
        outline: none;
        transition: border-color 0.2s;
        font-family: Calibri, sans-serif;
        background: #f0f0f0;
        color: #111;
    }
    .card input[type="text"]:focus, .card select:focus { border-color: #888; }
    .card textarea {
        padding: 6px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: none;
        min-height: 120px;
        font-family: Calibri, sans-serif;
        text-align: left;
        background: #f0f0f0;
        color: #111;
    }
    #traineeNameCard { flex: 0 0 33.33%; max-width: 33.33%; }
    #traineeNameCard select { width: 90%; margin: 0 auto; }
    .summary-card {
        background: #f5f5f5;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 20px;
        margin: 20px 0;
        width: 100%;
        max-width: 1200px;
        text-align: left;
        font-family: Calibri, sans-serif;
    }
    #avg {
        font-weight: bold;
        font-size: 20px;
        text-align: center;
        width: 100px;
        margin: 10px auto;
        font-family: Calibri, sans-serif;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
    }
    #finalScore {
        font-weight: bold;
        font-size: 22px;
        padding: 6px 12px;
        border-radius: 8px;
        background: #f0f0f0;
        display: inline-block;
        margin-top: 8px;
        transition: background 0.2s, border 0.2s;
        min-width: 60px;
        text-align: center;
        border: 1px solid #ccc;
    }
    #finalScore.highlight { border: 2px solid #a00; background: #f8dede; }
    #outputDisplay {
        background: #f0f0f0;
        border-radius: 10px;
        padding: 15px;
        font-family: Calibri, monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
        text-align: left;
        color: #111;
    }
    button {
        background: #888;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        transition: background 0.2s;
        margin-right: 10px;
    }
    button:hover { background: #555; }
    @media(max-width: 900px){
        .card-row { flex-direction: column; }
        #traineeNameCard { flex: 1 1 100%; max-width: 100%; }
    }
    #popupOverlay {
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    #popupBox {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }
    #popupBox textarea {
        width: 100%;
        height: 120px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
        resize: none;
        box-sizing: border-box;
    }


    #excelTableCard table { border-collapse: collapse; width: 100%; background: #fff; }
    #excelTableCard th, #excelTableCard td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; white-space: pre-wrap; }
    #excelTableCard th { background: #eee; }

#fullExcelTableCard table {
    border-collapse: collapse;
    width: 100%;
    background: #fff;
}

#fullExcelTableCard th,
#fullExcelTableCard td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: left;
    vertical-align: top;
    white-space: pre-wrap;
}

#fullExcelTableCard th {
    background: #eee;
}

.pc-circle-btn {
    position: absolute;
    top: 0px;
    right: 8px;

    width: 22px;
    height: 22px;
    border-radius: 50%;

    background: #FF9B49 !important;
    color: #FFF;
    border: none;

    font-size: 13px;
    font-weight: regular;
    line-height: 22px;

    cursor: pointer;
    padding: 0;
}

.pc-circle-btn:hover {
    background: #E6883F !important;
}

.checklist-popup {
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 9999;
    min-width: 200px;
    max-width: 250px;
    max-height: 300px;
    overflow-y: auto;
}

.trainee-circle-btn {
    position: absolute;
    top: 0px;
    right: 8px;

    width: 22px;
    height: 22px;
    border-radius: 50%;

    background: #AFE6FF !important;
    color: #FFF;
    border: none;

    font-size: 13px;
    font-weight: regular;
    line-height: 22px;

    cursor: pointer;
    padding: 0;
}

.trainee-circle-btn:hover {
    background: #86D1F4 !important;
}


/* Optional: make card position relative so the button is positioned inside it */
.card {
    position: relative;
    padding: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
}

.button-row {
    display: flex;      /* Put buttons side by side */
    gap: 10px;          /* Space between buttons */
    margin-top: 15px;   /* Space above buttons */
}

.button-row button {
    flex: 1;            /* Make buttons same width (optional) */
    padding: 8px 16px;
    cursor: pointer;
}


/* Trainee name cell stays normal */
.tn-cell {
    white-space: nowrap;
}

/* Inner wrapper handles alignment */
.tn-cell-inner {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Normalize the circle button inside tables */
.tn-cell-inner .trainee-circle-btn {
    position: static;
    width: 22px;
    height: 22px;
    line-height: 22px;
    flex-shrink: 0;
}

/* ------------------------
   Excel Table Vertical Alignment
   ------------------------ */
#fullExcelTable td,
#fullExcelTable th {
    vertical-align: middle;  /* center content vertically */
}

/* Trainee name cell: center the button + name */
.tn-cell-inner {
    display: flex;
    align-items: center;      /* vertically center button + text */
    gap: 6px;                 /* optional spacing between button and name */
}

/* Optional: make multi-line notes cells wrap nicely */
#fullExcelTable td {
    white-space: pre-wrap;    /* preserve line breaks in notes */
}


/* FIX: Align trainee blue circle with name in Excel table */
#fullExcelTable td.tn-cell {
    vertical-align: middle;
}

#fullExcelTable .tn-cell-inner {
    display: flex;
    align-items: center;   /* vertical centering */
}

#fullExcelTable .trainee-circle-btn {
    margin-top: 0;
    line-height: 22px;
}






</style>
</head>
<body>



<h1>WLPG Score Input</h1>

<div class="card-row" id="traineeNameCardRow">
    <div class="card" id="traineeNameCard">
        <label for="traineeName">Trainee Name</label>
        <select id="traineeName"><option value="">Select Name</option></select>
    </div>
</div>


<div class="card-row">


    <div class="card pc-card">
	<button class="pc-circle-btn" title="Open Orthography Grid Comments"></button>
        <label for="orthography">ORTHOGRAPHY</label>
        <input type="text" id="orthography" class="numInput" placeholder="0">
        <textarea id="orthography_text" placeholder="Notes"></textarea>
    </div>


    <div class="card pc-card">
	<button class="pc-circle-btn" title="GA Grid Comments"></button>
        <label for="ga">GA</label>
        <input type="text" id="ga" class="numInput" placeholder="0">
        <textarea id="ga_text" placeholder="Notes"></textarea>
    </div>

    <div class="card pc-card">
	<button class="pc-circle-btn" title="Style Grid Comments"></button>
        <label for="style">STYLE</label>
        <input type="text" id="style" class="numInput" placeholder="0">
        <textarea id="style_text" placeholder="Notes"></textarea>
    </div>

    <div class="card pc-card">
	<button class="pc-circle-btn" title="CR Grid Comments"></button>
        <label for="cr">CR</label>
        <input type="text" id="cr" class="numInput" placeholder="0">
        <textarea id="cr_text" placeholder="Notes"></textarea>
    </div>

</div>



<div class="card summary-card" id="excelTableCard">
    <h2>Live Excel Row Preview</h2>
    <table id="excelTable">
        <thead>
            <tr>
                <th>Trainee Name</th>
                <th>ORTHOGRAPHY</th><th>ORTHOGRAPHY Notes</th>
                <th>GA</th><th>GA Notes</th>
                <th>STYLE</th><th>STYLE Notes</th>
                <th>CR</th><th>CR Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr id="excelRow">
                <td id="tbl_traineeName"></td>
                <td id="tbl_orthography"></td><td id="tbl_orthography_notes"></td>
                <td id="tbl_ga"></td><td id="tbl_ga_notes"></td>
                <td id="tbl_style"></td><td id="tbl_style_notes"></td>
                <td id="tbl_cr"></td><td id="tbl_cr_notes"></td>
            </tr>
        </tbody>
    </table>
    <div class="button-row">
        <button id="copyExcelRowBtn">Copy as Excel Row</button>
        <button id="addEntryBtn">Save Entry</button>
    </div>
</div>


<div class="summary-card">
    <h2>WLPG Score</h2>
    <div><input type="text" id="avg" readonly placeholder="—"></div>
    <div id="outputDisplay"></div>

    <button id="copyBtn">Copy Entry</button>
    <button id="viewAllBtn">View All Entries</button>
    <button id="downloadAllBtn">Download All Entries (.txt)</button>
    <button id="exportExcelBtn">Export to Excel</button>
</div>


<div class="card summary-card" id="fullExcelTableCard">
    <h2>All Trainees – Excel Table Preview</h2>
    <table id="fullExcelTable">
        <thead>
            <tr>
                <th>Trainee Name</th>
                <th>ORTHOGRAPHY</th><th>ORTHOGRAPHY Notes</th>
                <th>GA</th><th>GA Notes</th>
                <th>STYLE</th><th>STYLE Notes</th>
                <th>CR</th><th>CR Notes</th>
                <th>WLPG Final Score</th>
            </tr>
        </thead>
        <tbody id="fullExcelBody"></tbody>
    </table>
    <button id="copyAllExcelRowsBtn">Copy All as Excel Table</button>
</div>

<div id="popupOverlay" style="display: flex;">
    <div id="popupBox">
        <h2>Enter Trainee Names (one per line)</h2>
        <textarea id="nameInput" placeholder="Enter names here..."></textarea>
        <br><br>
        <button id="saveNamesBtn">Save Names</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>


// ------------------- Trainee Name Popup -------------------
document.getElementById("saveNamesBtn").addEventListener("click", () => {
    const namesText = document.getElementById("nameInput").value;
    if (!namesText.trim()) { alert("Please enter at least one name."); return; }
    const names = namesText.split("\n").map(n=>n.trim()).filter(n=>n!=="");
    const select = document.getElementById("traineeName");
    select.innerHTML = '<option value="">Select Name</option>';
    names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        select.appendChild(opt);
    });
    document.getElementById("popupOverlay").style.display = "none";
    updateFullExcelTable()
});

// ------------------- Scoring Logic -------------------
function getFinalScore(avg) {
    return avg || "0";
}

function updateAverage() {
    const ids=["orthography","ga","style","cr"];
    let values=[];
    ids.forEach(id=>{
        let v=document.getElementById(id).value;
        if(v.trim()!=="" && !isNaN(v)) values.push(parseFloat(v));
    });
    const avgField=document.getElementById("avg");
    const finalSpan=document.getElementById("finalScore");
    if(values.length===0){
        avgField.value="";
        finalSpan.textContent="0";
        finalSpan.classList.add("highlight");
    } else{
        let avg=values.reduce((a,b)=>a+b,0)/values.length;
        avgField.value=avg.toFixed(2);
        const finalScore=getFinalScore(avg);
        finalSpan.textContent=finalScore;
        if(finalScore==0) finalSpan.classList.add("highlight");
        else finalSpan.classList.remove("highlight");
    }
    updateConsolidated();
    updateExcelTableCard();
}

function updateConsolidated(){
    const ids=["orthography","ga","style","cr"];
    const avg=document.getElementById("avg").value;
    const finalScore=getFinalScore(avg);

    const lines=[
        `Trainee Name: ${document.getElementById("traineeName").value || ""}`,
        `WLPG Score: ${ids.map(id=>document.getElementById(id).value||"0").join(" ")} = ${avg}`,
        `WLPG Final Score: ${avg}`,
        ""
    ];

    ids.forEach(id=>{
        const value=document.getElementById(id).value||"";
        const text=document.getElementById(id+"_text").value||"";
        lines.push(`${id.toUpperCase()}: ${value}`);
        if(text) lines.push(text);
        lines.push("");
    });

    document.getElementById("outputDisplay").textContent=lines.join("\n");
}

// ------------------- Input Validation -------------------
document.querySelectorAll(".numInput").forEach(input=>{
    input.addEventListener("input",()=>{
        input.value=input.value.replace(/[^0-9.]/g,"");
        const parts=input.value.split(".");
        if(parts.length>2) input.value=parts[0]+"."+parts[1];
        updateAverage();
    });
});

["orthography_text","ga_text","style_text","cr_text","traineeName"].forEach(id=>{
    document.getElementById(id).addEventListener("input", updateConsolidated);
});

// ------------------- Multi-entry storage -------------------
let allEntries = [];

function resetAllFields() {
    // Reset trainee name
    const t = document.getElementById("traineeName");
    t.selectedIndex = 0;
    t.dispatchEvent(new Event("input"));

    // Reset numeric and notes inputs
    ["orthography","ga","style","cr"].forEach(id => {
        const inp = document.getElementById(id);
        const notes = document.getElementById(id+"_text");
        inp.value = "";
        notes.value = "";
        inp.dispatchEvent(new Event("input"));      // triggers updateAverage()
        notes.dispatchEvent(new Event("input"));    // triggers updateConsolidated()
    });

    // Reset summary fields
    document.getElementById("avg").value = "";
    const final = document.getElementById("finalScore");
    final.textContent = "0";
    final.classList.add("highlight");

    // Clear consolidated output
    document.getElementById("outputDisplay").textContent = "";

    // Finally, force the preview to update from cleared values
    updateExcelTableCard();
}


// Save entry
document.getElementById("addEntryBtn").addEventListener("click", () => {
    const traineeName = document.getElementById("traineeName").value; // capture before reset
    const text = document.getElementById("outputDisplay").textContent.trim();

    if (text.length < 5){ alert("Nothing to save — please enter a score first."); return; }

    allEntries.push(text); // save the entry

    alert("Entry saved! Total entries: " + allEntries.length);

    // update the table **before resetting the inputs**
    updateFullExcelTable();

    // now clear the form
    resetAllFields();

    formChanged = false;
});

// Copy consolidated notes
document.getElementById("copyBtn").addEventListener("click",()=>{
    navigator.clipboard.writeText(document.getElementById("outputDisplay").textContent);
    alert("Consolidated output copied!");
});

// Download all entries
document.getElementById("downloadAllBtn").addEventListener("click", () => {
    if (allEntries.length === 0) {
        alert("No entries to download.");
        return;
    }
    let content = allEntries.join("\n\n=== End of Entry ===\n\n");
    const blob = new Blob([content], { type: 'text/plain' });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "all_entries.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});

// View all entries
document.getElementById("viewAllBtn").addEventListener("click", () => {
    const win = window.open("", "_blank");
    let content = "";
    allEntries.forEach((entry, i) => { content += `=== Entry ${i+1} ===\n${entry}\n\n`; });
    win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>All Saved Entries</title>
            <style>
                body { font-family: Calibri, sans-serif; padding: 20px; background: #f5f5f5; }
                pre { background: #fff; padding: 20px; border-radius: 8px; white-space: pre-wrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
            </style>
        </head>
        <body>
            <h2>All Saved WLPG Entries</h2>
            <pre>${content}</pre>
        </body>
        </html>
    `);
});

// ------------------- Live Excel Table Card -------------------
function updateExcelTableCard() {
    document.getElementById("tbl_traineeName").textContent = document.getElementById("traineeName").value || "";
    ["orthography","ga","style","cr"].forEach(id => {
        document.getElementById("tbl_"+id).textContent = document.getElementById(id).value || "";
        document.getElementById("tbl_"+id+"_notes").textContent = document.getElementById(id+"_text").value || "";
    });
}

["traineeName","orthography","orthography_text","ga","ga_text","style","style_text","cr","cr_text"].forEach(id => {
    document.getElementById(id).addEventListener("input", updateExcelTableCard);
});

/* ==============================
   FIXED COPY BLOCK STARTS HERE
   ============================== */

// Copy Excel Row
document.getElementById("copyExcelRowBtn").addEventListener("click", () => {
    const row = [];
    const ids = ["orthography", "ga", "style", "cr"];

    // Skip trainee name, only add scores and notes
    ids.forEach(id => {
        let score = document.getElementById("tbl_" + id).textContent || "";
        let notes = document.getElementById("tbl_" + id + "_notes").textContent || "";

        if (notes.includes('"')) notes = notes.replace(/"/g,'""');
        if (notes.includes("\n")) notes = `"${notes}"`;

        row.push(score, notes);
    });

    navigator.clipboard.writeText(row.join("\t"))
        .then(() => alert("Data copied as Excel row (without trainee name)!"));
});



// Copy ALL Excel rows
document.getElementById("copyAllExcelRowsBtn").addEventListener("click", () => {
    let output = "";
    const rows = document.querySelectorAll("#fullExcelBody tr");

    rows.forEach(row => {
        // Grab only the score and notes cells (skip first and last)
        const cells = [...row.querySelectorAll("td")].slice(1, -1).map(td => {
            let text = td.innerText || "";

            // Handle quotes and newlines
            if (text.includes('"')) text = text.replace(/"/g,'""');
            if (text.includes("\n")) text = `"${text}"`;

            return text;
        });

        output += cells.join("\t") + "\n";
    });

    navigator.clipboard.writeText(output)
        .then(() => alert("Excel table copied (without trainee name & final score)!"))
        .catch(() => alert("Copy failed. Try again."));
});

// Export to Excel
document.getElementById("exportExcelBtn").addEventListener("click", () => {
    const traineeSelect = document.getElementById("traineeName");
    const allTrainees = [];
    for (let i = 1; i < traineeSelect.options.length; i++) {
        allTrainees.push(traineeSelect.options[i].value.trim());
    }

    const savedData = {};

    allEntries.forEach(entry => {
        const lines = entry.split("\n");

        const name = lines[0].replace("Trainee Name: ", "").trim();
        const finalScore = lines[2].replace("WLPG Final Score: ", "").trim();

        const getBlock = (label) => {
            const index = lines.findIndex(l => l.startsWith(label + ":"));
            if (index===-1) return { score:"", notes:"" };
            const score = lines[index].replace(label + ":", "").trim();
            let notes = "";

            let i = index + 1;
            while (
    i < lines.length &&
    !/^(ORTHOGRAPHY|GA|STYLE|CR):$/.test(lines[i].trim()) &&
    lines[i].trim() !== ""
) {

                if (notes) notes += "\n";
                notes += lines[i].trim();
                i++;
            }
            return { score, notes };
        };

        savedData[name] = {
            ORTHOGRAPHY: getBlock("ORTHOGRAPHY"),
            GA: getBlock("GA"),
            STYLE: getBlock("STYLE"),
            CR: getBlock("CR"),
            FinalScore: finalScore
        };
    });

    const rows = allTrainees.map(name => {
        const d = savedData[name] || {
            ORTHOGRAPHY:{score:"",notes:""},
            GA:{score:"",notes:""},
            STYLE:{score:"",notes:""},
            CR:{score:"",notes:""},
            FinalScore:""
        };

        return {
            "Trainee Name": name,
            "ORTHOGRAPHY": d.ORTHOGRAPHY.score,
            "ORTHOGRAPHY Notes": d.ORTHOGRAPHY.notes,
            "GA": d.GA.score,
            "GA Notes": d.GA.notes,
            "STYLE": d.STYLE.score,
            "STYLE Notes": d.STYLE.notes,
            "CR": d.CR.score,
            "CR Notes": d.CR.notes,
            "Final Score": d.FinalScore
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(rows);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "WLPG Scores");
    XLSX.writeFile(workbook, "WLPG_All_Trainees.xlsx");
});

function updateFullExcelTable() {
    const tbody = document.getElementById("fullExcelBody");
    tbody.innerHTML = "";

    const traineeSelect = document.getElementById("traineeName");
    const allTrainees = [];
    for (let i = 1; i < traineeSelect.options.length; i++) {
        allTrainees.push(traineeSelect.options[i].value.trim());
    }

    const savedData = {};

    allEntries.forEach(entry => {
        const lines = entry.split("\n");
        const name = lines[0].replace("Trainee Name: ", "").trim();
        const finalScore = lines[2].replace("WLPG Final Score: ", "").trim();

        const getBlock = (label) => {
            const index = lines.findIndex(l => l.startsWith(label + ":"));
            if (index===-1) return { score:"", notes:"" };
            const score = lines[index].replace(label + ":", "").trim();
            let notes = "";

            let i = index + 1;
            while (
    i < lines.length &&
    !/^(ORTHOGRAPHY|GA|STYLE|CR):$/.test(lines[i].trim()) &&
    lines[i].trim() !== ""
) {

                if (notes) notes += "\n";
                notes += lines[i].trim();
                i++;
            }
            return { score, notes };
        };

        savedData[name] = {
            ORTHOGRAPHY: getBlock("ORTHOGRAPHY"),
            GA: getBlock("GA"),
            STYLE: getBlock("STYLE"),
            CR: getBlock("CR"),
            FinalScore: finalScore
        };
    });

    allTrainees.forEach(name => {
        const d = savedData[name] || {
            ORTHOGRAPHY:{score:"",notes:""},
            GA:{score:"",notes:""},
            STYLE:{score:"",notes:""},
            CR:{score:"",notes:""},
            FinalScore:""
        };

        const row = document.createElement("tr");

        row.innerHTML = `
    	<td class="tn-cell">
    <div class="tn-cell-inner">
        <button class="trainee-circle-btn" title="Copy this trainee's row"></button>
        <span>${name}</span>
    	</div>
	</td>

            <td>${d.ORTHOGRAPHY.score}</td><td>${d.ORTHOGRAPHY.notes.replace(/\n/g,'<br>')}</td>
            <td>${d.GA.score}</td><td>${d.GA.notes.replace(/\n/g,'<br>')}</td>
            <td>${d.STYLE.score}</td><td>${d.STYLE.notes.replace(/\n/g,'<br>')}</td>
            <td>${d.CR.score}</td><td>${d.CR.notes.replace(/\n/g,'<br>')}</td>
            <td>${d.FinalScore}</td>
        `;

        tbody.appendChild(row);
    });
}


// Copy individual trainee row (Excel-ready, without Final Score)
document.getElementById("fullExcelBody").addEventListener("click", (e) => {
    const btn = e.target.closest(".trainee-circle-btn");
    if (!btn) return;

    const row = btn.closest("tr");
    if (!row) return;

    // EXCLUDE first and last column (Trainee name and Final Score)
    const cells = [...row.querySelectorAll("td")].slice(1, -1).map(td => {
        let text = td.innerText || "";

        if (text.includes('"')) text = text.replace(/"/g, '""');
        if (text.includes("\n")) text = `"${text}"`;

        return text;
    });

    navigator.clipboard.writeText(cells.join("\t"))
        .then(() => alert("Excel row copied (without Final Score)!"))
        .catch(() => alert("Copy failed."));
});










updateExcelTableCard();

let formChanged = false;
document.querySelectorAll("input, textarea, select").forEach(el => {
    el.addEventListener("input", () => { formChanged = true; });
});

window.addEventListener("beforeunload", (event) => {
    if (formChanged) {
        event.preventDefault();
        event.returnValue = "";
    }
});


</script>








<script>




const checklistData = {
    orthography_text: [
    { header: "6", items: ["Has no errors on the following:\n• Spelling\n• Hyphenation\n• Capitalization\n• Word breaks\n• Punctuation\n• Emphasis"] },
    { header: "5", items: ["• Errors are insignificant", "• Orthography mistakes are rare"] },
    { header: "4", items: ["• Errors may be present but are generally negligible", "• Orthography mistakes are present sometimes"] },
    { header: "3", items: ["• Errors are noticeable and a bit distracting", "• Orthography mistakes are present most of the time"] },
    { header: "2", items: ["• Errors are noticeable and distracting", "• Orthography mistakes are present almost always"] },
    { header: "1", items: ["• Errors are noticeable and cause confusion", "• Orthography mistakes are present always"] },
    { header: "0", items: ["• Non-user"] }
],

    ga_text: [
    { header: "6", items: ["Has no errors on the following:\n• Subject-Verb Agreement\n• Verb Tenses and Forms\n• Articles and Numbers\n• Prepositions and Conjunctions\n• Grammatical Structure\n• Others (Pronoun Usage, Parallelism, Modifiers, etc.)"] },
    { header: "5", items: ["• Errors are insignificant", "• Errors are rare"] },
    { header: "4", items: ["• Errors may be seen but are generally negligible", "• Errors may be seen sometimes"] },
    { header: "3", items: ["• Errors are noticeable and a bit distracting", "• Errors may be seen most of the time"] },
    { header: "2", items: ["• Errors are noticeable and distracting", "• Errors may be seen almost always"] },
    { header: "1", items: ["• Errors cause confusion and become a hindrance during conversation", "• Errors may be seen always"] },
    { header: "0", items: ["• Non-user"] }
],

    style_text: [
        { header: "6", items: ["• Consistently uses sentences that have an expressive and professional tone", "• Uses sophisticated expressions (idioms, robust vocabulary)", "• Uses words that capture the ideas s/he is trying to convey"] },
    { header: "5", items: ["• Uses sentences that have an expressive and professional tone most of the time", "• Uses words that capture the ideas s/he is trying to convey"] },
    { header: "4", items: ["• Uses sentences that have an expressive and professional tone most of the time", "• Is able to convey thoughts in English but sometimes uses words that do not always capture the idea s/he is trying to convey"] },
    { header: "3", items: ["• Uses sentences that have a professional tone", "• Is able to convey thoughts in English but words used are a direct translation of Filipino to English"] },
    { header: "2", items: ["• Uses sentences that have an informal and unprofessional tone", "• Has difficulty putting thoughts into writing and switches frequently between languages", "• Uses words that do not have any conclusive meaning in English"] },
    { header: "1", items: ["• Uses sentences that have an informal and unprofessional tone", "• Has difficulty putting thoughts into writing. Responses are too short and ends up with very little to work with"] },
    { header: "0", items: ["• Non-user"] }
],

    cr_text: [
        { header: "6", items: ["• Understands statements and questions with ease", "• Gives accurate and comprehensive answers that correctly address the question", "• Has clear and well developed organizing structure", "• Uses appropriate transitional words/phrases", "• *If chat environment is simulated: Responds within 0-20 seconds from when question is asked"] },
    { header: "5", items: ["• Understands statements and questions but may ask for clarification", "• Always provides answers that correctly address the question", "• Has clear organizing structure", "• Uses transitional words/phrases (with rare inappropriate transition or sentence organization error)", "• *If chat environment is simulated: Responds within 0-20 seconds from when question is asked"] },
    { header: "4", items: ["• Understands statements and questions but may ask for clarification occasionally", "• Generally answers questions with not more than one inappropriate response", "• Has adequate organizing structure", "• Uses transitional words/phrases (with occasional inappropriate transitions or sentence organization errors)", "• *If chat environment is simulated: Responds within 0-30 seconds from when question is asked"] },
    { header: "3", items: ["• Responses are sometimes inappropriate or incomplete or limited to one-word answers", "• Has inadequate organizing structure", "• Uses transitional words/phrases that are confusing", "• *If chat environment is simulated: Takes time to respond to questions asked (took more than 30 but not longer than 60 seconds)"] },
    { header: "2", items: ["• Responses are often inappropriate or incomplete or limited to one-word answers", "• Has weak organizing structure with an inconsistent focus", "• *If chat environment is simulated: Takes time to respond to questions asked (more than 1 minute per response)"] },
    { header: "1", items: ["• Responses are always off-tangent", "• Organization has no clear structure or focus", "• *If chat environment is simulated: Takes time to respond to questions asked (more than 1 minute per response)"] },
    { header: "0", items: ["• Non-user"] }
    ]
};


let currentTextarea = null;

// Create popup and handle checkbox changes
document.querySelectorAll(".pc-circle-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
        const textarea = btn.parentElement.querySelector("textarea");
        currentTextarea = textarea;

        // Remove existing popup if any
        document.querySelectorAll(".checklist-popup").forEach(p => p.remove());

        // Create popup container
        const popup = document.createElement("div");
        popup.className = "checklist-popup";




const groups = checklistData[textarea.id] || [];
groups.forEach(group => {
    // Add header
    const header = document.createElement("div");
    header.textContent = group.header;
    header.style.fontWeight = "bold";
    header.style.margin = "8px 0 4px 0";
    popup.appendChild(header);

    // Add checkboxes
    group.items.forEach(item => {
        const label = document.createElement("label");
        label.style.display = "block";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = item;
        checkbox.checked = textarea.value.split("\n").includes(item);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + item));
        popup.appendChild(label);
    });
});



        document.body.appendChild(popup);

        // Position near button
        const rect = btn.getBoundingClientRect();
        let top = rect.bottom + window.scrollY + 5;
        let left = rect.left + window.scrollX;

        // Prevent overflow
        if(top + popup.offsetHeight > window.scrollY + window.innerHeight){
            top = rect.top + window.scrollY - popup.offsetHeight - 5;
        }
        if(left + popup.offsetWidth > window.scrollX + window.innerWidth){
            left = window.scrollX + window.innerWidth - popup.offsetWidth - 5;
        }

        popup.style.top = top + "px";
        popup.style.left = left + "px";

        // Handle checkbox changes
        popup.addEventListener("change", (e) => {
    if (e.target.tagName !== "INPUT") return;

    const checkboxes = popup.querySelectorAll("input[type=checkbox]");
    const lines = currentTextarea.value.split("\n").filter(l => l); // preserve other notes
    const otherNotes = lines.filter(line => {
        return !Array.from(checkboxes).some(cb => cb.value === line);
    });

    // Get all checked items in order
    const checkedItems = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

    currentTextarea.value = [...checkedItems, ...otherNotes].join("\n");

    // Update outputs
    updateConsolidated();
    updateExcelTableCard();
    updateFullExcelTable();
});

    });
});

// Optional: click outside to close popup
document.addEventListener("click", (e)=>{
    if(!e.target.closest(".pc-circle-btn") && !e.target.closest(".checklist-popup")){
        document.querySelectorAll(".checklist-popup").forEach(p => p.remove());
    }
});
</script>



</body>
</html>
